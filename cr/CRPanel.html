<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CUOnline CR Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <style>
    :root {
      --primary: #363763;
      --primary-2: #1e1f4a;
      --danger: #BD3850;
      --success: #22c25f;
      --bg: #f4f5f7;
      --card: #ffffff;
      --text: #1b1e28;
      --muted: #6b7280;
      --line: #e5e7eb;
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); }

    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 18px; }
    .phone { width: min(430px, 100%); border: 1px solid #d7dbe2; border-radius: 26px; overflow: hidden; background: var(--card); box-shadow: 0 10px 24px rgba(0,0,0,.10); display: flex; flex-direction: column; }

    .topbar { background: linear-gradient(180deg, var(--primary-2), var(--primary)); color: #fff; padding: 14px; border-bottom: 1px solid rgba(255,255,255,.18); flex-shrink: 0; }
    .topbar .h { font-weight: 700; font-size: 16px; letter-spacing: .2px; }
    .topbar .s { opacity: .85; font-size: 12px; }

    .content { padding: 12px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; flex: 1; }
    .card { border: 1px solid var(--line); border-radius: var(--radius); padding: 12px; background: #fff; }
    .card .h { font-weight: 800; margin-bottom: 10px; }

    .tabs { display: flex; gap: 8px; margin-bottom: 10px; }
    .tab-btn { flex: 1; padding: 8px; border: 1px solid var(--line); background: #fff; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; }
    .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    input, textarea, select { width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(54,55,99,.12); }
    textarea { min-height: 70px; resize: vertical; }

    .btn { width: 100%; padding: 10px; border: 1px solid var(--line); background: #f8fafc; color: var(--text); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.2s; margin-bottom: 8px; }
    .btn:last-child { margin-bottom: 0; }
    .btn:hover { background: #eef2f7; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.primary:hover { background: var(--primary-2); }
    .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn.success:hover { background: #1aa84f; }

    .video-container { width: 100%; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    video, canvas { width: 100%; height: auto; display: block; }

    .session-info { background: #f8fafc; border: 1px solid var(--line); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 13px; }
    .session-info .key { color: var(--muted); font-weight: 600; }
    .session-info .val { font-weight: 700; }

    .student-item { padding: 10px; border: 1px solid var(--line); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .student-item .name { font-weight: 700; font-size: 13px; }
    .student-item .reg { color: var(--muted); font-size: 12px; }

    .attendance-btn { display: flex; gap: 6px; }
    .radio { width: 32px; height: 28px; border-radius: 6px; border: 1px solid var(--line); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .radio:hover { border-color: var(--primary); }
    .radio.onP { border-color: rgba(34,194,107,.40); background: rgba(34,194,107,.15); color: var(--success); }
    .radio.onA { border-color: rgba(189,56,80,.40); background: rgba(189,56,80,.15); color: var(--danger); }

    .footer { border-top: 1px solid var(--line); padding: 12px; background: #fff; flex-shrink: 0; }
    .footer .btn { margin-bottom: 6px; }

    .status-msg { padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; }
    .status-msg.success { background: rgba(34,194,107,.15); color: #155724; border: 1px solid rgba(34,194,107,.3); }
    .status-msg.error { background: rgba(189,56,80,.15); color: #721c24; border: 1px solid rgba(189,56,80,.3); }
    .status-msg.info { background: rgba(54,55,99,.15); color: var(--text); border: 1px solid rgba(54,55,99,.3); }

    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .badge.online { background: rgba(34,194,107,.15); color: var(--success); border: 1px solid rgba(34,194,107,.3); }

    .meta { display: grid; gap: 6px; font-size: 12px; margin-bottom: 10px; }
    .kv { display: flex; gap: 10px; align-items: baseline; }
    .k { width: 60px; color: var(--muted); font-weight: 600; }
    .v { font-weight: 700; }

    .pill2 { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 11px; border: 1px solid var(--line); background: #f8fafc; color: var(--muted); }

    .summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

    @media (max-width: 360px) {
      .radio { width: 30px; height: 26px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="phone" role="application" aria-label="CUOnline CR Panel">
      <div class="topbar">
        <div class="h">üì± CUOnline CR</div>
        <div class="s">QR-based Attendance</div>
      </div>

      <div class="content" id="mainContent">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('scan')">Scan QR</button>
          <button class="tab-btn" onclick="switchTab('manual')">Manual Entry</button>
          <button class="tab-btn" onclick="switchTab('history')">History</button>
        </div>

        <!-- TAB 1: SCAN QR -->
        <div id="scan" class="tab-pane active">
          <div class="card">
            <div class="h">üì∏ Scan QR Code</div>
            <div class="video-container">
              <video id="video" width="100%" height="300"></video>
            </div>
            <button class="btn primary" onclick="startCamera()">Start Camera</button>
            <button class="btn" onclick="stopCamera()">Stop Camera</button>
            <div id="scanStatus" class="status-msg info" style="display: none;"></div>
          </div>
        </div>

        <!-- TAB 2: MANUAL ENTRY -->
        <div id="manual" class="tab-pane">
          <div class="card">
            <div class="h">üìã Manual Entry</div>
            <div class="form-group">
              <label>Course</label>
              <input type="text" id="manualCourse" placeholder="CSC462">
            </div>
            <div class="form-group">
              <label>Section</label>
              <input type="text" id="manualSection" placeholder="A">
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="manualDate">
            </div>
            <button class="btn primary" onclick="loadSessionManually()">Load Session</button>
            <div id="manualStatus"></div>
          </div>
        </div>

        <!-- TAB 3: HISTORY -->
        <div id="history" class="tab-pane">
          <div class="card">
            <div class="h">üìú Submission History</div>
            <div id="historyList" style="font-size: 12px;"></div>
          </div>
        </div>
      </div>

      <!-- SESSION LOADED -->
      <div class="content" id="sessionContent" style="display: none;">
        <div class="card">
          <div class="summary">
            <div class="h" id="sessionTitle">Session</div>
            <div class="pill2" id="studentCount">25 students</div>
          </div>
          <div class="session-info">
            <div class="kv"><div class="k">Course</div><div class="val" id="sessionCourse">-</div></div>
            <div class="kv"><div class="k">Section</div><div class="val" id="sessionSection">-</div></div>
            <div class="kv"><div class="k">Date</div><div class="val" id="sessionDate">-</div></div>
          </div>
          <div class="meta" style="background: #f8fafc; padding: 8px; border-radius: 6px;">
            <div class="kv"><div class="k">Present</div><div class="val" style="color: var(--success);" id="presentCount">0</div></div>
            <div class="kv"><div class="k">Absent</div><div class="val" style="color: var(--danger);" id="absentCount">0</div></div>
          </div>
        </div>

        <div class="card">
          <div class="h">üë• Students</div>
          <input type="search" id="studentSearch" placeholder="Search by name or reg no" style="margin-bottom: 10px;" oninput="filterStudents()">
          <div id="studentList"></div>
        </div>

        <div class="card">
          <div class="h">üìù Notes (Optional)</div>
          <textarea id="lectureNotes" placeholder="Class covered..." maxlength="500"></textarea>
          <div style="font-size: 11px; color: var(--muted); margin-top: 4px;"><span id="noteCount">0</span>/500</div>
        </div>
      </div>

      <div class="footer" id="sessionFooter" style="display: none;">
        <button class="btn" onclick="resetSession()">‚Üê Back to Scan</button>
        <button class="btn success" onclick="submitAttendance()">‚úì Submit Attendance</button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      BACKEND_URL: 'https://script.google.com/macros/s/YOUR_ADMIN_SCRIPT_ID/userweb'
    };

    let sessionData = null;
    let currentRoster = [];
    let attendance = {};
    let submissionHistory = [];

    // SET TODAY'S DATE
    document.getElementById('manualDate').valueAsDate = new Date();

    function switchTab(tabName) {
      document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'scan') startCamera();
      else stopCamera();
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          const video = document.getElementById('video');
          video.srcObject = stream;
          video.play();
          scanQRCode();
        })
        .catch(() => alert('Camera access denied'));
    }

    function stopCamera() {
      const video = document.getElementById('video');
      if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    }

    function scanQRCode() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const scan = () => {
        if (video.srcObject) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            try {
              sessionData = JSON.parse(code.data);
              loadSessionFromQR();
            } catch (e) {
              console.log('Invalid QR format');
            }
          }
        }
        requestAnimationFrame(scan);
      };
      scan();
    }

    function loadSessionFromQR() {
      if (!sessionData) return;
      currentRoster = sessionData.roster || [];
      attendance = {};
      displaySession();
      stopCamera();
    }

    function loadSessionManually() {
      sessionData = {
        course: document.getElementById('manualCourse').value,
        section: document.getElementById('manualSection').value,
        date: document.getElementById('manualDate').value
      };

      // DEMO: Load demo roster
      currentRoster = [
        { regNo: 'FA22-BCS-008', name: 'AQSA HANIF', section: 'A' },
        { regNo: 'FA22-BCS-078', name: 'MUHAMMAD SALMAN', section: 'A' },
        { regNo: 'SP23-BCS-006', name: 'ABEERA EJAZ', section: 'A' },
        { regNo: 'SP23-BCS-022', name: 'HAMZA AZEEM', section: 'A' },
        { regNo: 'SP23-BCS-029', name: 'MEHREEN YOUNAS', section: 'A' },
        { regNo: 'SP23-BCS-031', name: 'MOAZ SAEED', section: 'A' }
      ];
      attendance = {};
      displaySession();
    }

    function displaySession() {
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('sessionContent').style.display = 'flex';
      document.getElementById('sessionFooter').style.display = 'block';

      document.getElementById('sessionCourse').textContent = sessionData.course;
      document.getElementById('sessionSection').textContent = sessionData.section;
      document.getElementById('sessionDate').textContent = sessionData.date;
      document.getElementById('studentCount').textContent = currentRoster.length + ' students';
      document.getElementById('sessionTitle').textContent = `${sessionData.course}-${sessionData.section}`;

      renderStudentList();
    }

    function renderStudentList() {
      const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
      const container = document.getElementById('studentList');
      let html = '';

      currentRoster
        .filter(s => !searchTerm || s.name.toLowerCase().includes(searchTerm) || s.regNo.includes(searchTerm))
        .forEach(student => {
          const status = attendance[student.regNo] || '';
          const btnP = status === 'P' ? 'onP' : '';
          const btnA = status === 'A' ? 'onA' : '';
          html += `
            <div class="student-item">
              <div>
                <div class="name">${student.name}</div>
                <div class="reg">${student.regNo}</div>
              </div>
              <div class="attendance-btn">
                <div class="radio ${btnP}" onclick="markAttendance('${student.regNo}', 'P')">P</div>
                <div class="radio ${btnA}" onclick="markAttendance('${student.regNo}', 'A')">A</div>
              </div>
            </div>
          `;
        });

      container.innerHTML = html;
      updateCounts();
    }

    function filterStudents() {
      renderStudentList();
    }

    function markAttendance(regNo, status) {
      if (attendance[regNo] === status) {
        delete attendance[regNo];
      } else {
        attendance[regNo] = status;
      }
      renderStudentList();
    }

    function updateCounts() {
      let present = 0, absent = 0;
      Object.values(attendance).forEach(s => {
        if (s === 'P') present++;
        else if (s === 'A') absent++;
      });
      document.getElementById('presentCount').textContent = present;
      document.getElementById('absentCount').textContent = absent;
    }

    function resetSession() {
      sessionData = null;
      currentRoster = [];
      attendance = {};
      document.getElementById('mainContent').style.display = 'flex';
      document.getElementById('sessionContent').style.display = 'none';
      document.getElementById('sessionFooter').style.display = 'none';
      document.getElementById('studentSearch').value = '';
    }

    document.getElementById('lectureNotes').addEventListener('input', function() {
      document.getElementById('noteCount').textContent = this.value.length;
    });

    function submitAttendance() {
      if (!sessionData) return;
      const notes = document.getElementById('lectureNotes').value;
      const data = {
        course: sessionData.course,
        section: sessionData.section,
        date: sessionData.date,
        roster: currentRoster,
        attendance,
        notes
      };

      submissionHistory.push({ ...data, timestamp: new Date().toLocaleString() });
      localStorage.setItem('submissionHistory', JSON.stringify(submissionHistory));

      alert('‚úì Attendance submitted successfully!');
      resetSession();
    }

    // LOAD HISTORY
    window.addEventListener('load', () => {
      submissionHistory = JSON.parse(localStorage.getItem('submissionHistory') || '[]');
      if (submissionHistory.length > 0) {
        let html = '';
        submissionHistory.slice().reverse().forEach(sub => {
          html += `<div style="padding: 8px; border-bottom: 1px solid var(--line);"><strong>${sub.course}-${sub.section}</strong> (${sub.date})<br><small style="color: var(--muted);">${sub.timestamp}</small></div>`;
        });
        document.getElementById('historyList').innerHTML = html;
      }
    });
  </script>
</body>
</html>